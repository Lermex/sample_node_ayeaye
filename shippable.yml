# Language setting
language: node_js

env:
  global:
    - REPO=sample-node-eb-docker
    - DOCKER_HUB_URL=ttrahan # {account name}
    - QUAY_URL=quay.io/ttrahan # quay.io/{account name}
    - AMAZON_ECR_URL=288971733297.dkr.ecr.us-east-1.amazonaws.com # {AWS account ID}.dkr.ecr.us-east-1
    - GCR_URL=gcr.io/shippable-gke # gcr.io/{project id}
    - AWS_EB_DOCKER_CONFIG="shippable-demo-eb/credentials/dockerconfig.all" # S3 location of docker credentials

build:
  ci:
    - echo 'CI is running'
  post_ci:
      - docker build -t="ttrahan/$REPO:$BRANCH.$BUILD_NUMBER" .
      # Pushing to 4 different registries
      # DockerHub
      # - docker push $DOCKER_HUB_URL/$REPO:$BRANCH.$BUILD_NUMBER
      # ECR
      # - docker tag ttrahan/$REPO:$BRANCH.$BUILD_NUMBER $AMAZON_ECR_URL/$REPO:$BRANCH.$BUILD_NUMBER
      # - docker push $AMAZON_ECR_URL/$REPO:$BRANCH.$BUILD_NUMBER
      # # Google Container Registry
      # - docker tag ttrahan/$REPO:$BRANCH.$BUILD_NUMBER $GCR_URL/$REPO:$BRANCH.$BUILD_NUMBER
      # - docker push $GCR_URL/$REPO:$BRANCH.$BUILD_NUMBER
      # Quay
      - docker tag ttrahan/$REPO:$BRANCH.$BUILD_NUMBER $QUAY_URL/$REPO:$BRANCH.$BUILD_NUMBER
      - docker push $QUAY_URL/$REPO:$BRANCH.$BUILD_NUMBER

integrations:
  deploy:
    # # Docker Hub
    # - integrationName: "AWS - ttrahan"
    #   type: aws
    #   target: eb_docker
    #   application_name: "shippable-demo-eb"
    #   env_name: "eb-docker"
    #   bucket_name: "elasticbeanstalk-us-east-1-288971733297"
    #   region: "us-east-1"
    #   image_name: "$DOCKER_HUB_URL/$REPO"
    #   image_tag: "$BRANCH.$BUILD_NUMBER"

    # # Amazon ECR
    # - integrationName: "AWS - ttrahan"
    #   type: aws
    #   target: eb_docker
    #   application_name: "shippable-demo-eb"
    #   env_name: "eb-docker"
    #   bucket_name: "elasticbeanstalk-us-east-1-288971733297"
    #   region: "us-east-1"
    #   image_name: "$AMAZON_ECR_URL/$REPO"
    #   image_tag: "$BRANCH.$BUILD_NUMBER"

    # # Google Container Registry
    # - integrationName: "AWS - ttrahan"
    #   type: aws
    #   target: eb_docker
    #   application_name: "shippable-demo-eb"
    #   env_name: "eb-docker"
    #   bucket_name: "elasticbeanstalk-us-east-1-288971733297"
    #   region: "us-east-1"
    #   image_name: "$GCR_URL/$REPO"
    #   image_tag: "$BRANCH.$BUILD_NUMBER"

    # Quay
    - integrationName: "AWS - ttrahan"
      type: aws
      target: eb_docker
      application_name: "shippable-demo-eb"
      env_name: "eb-docker"
      bucket_name: "elasticbeanstalk-us-east-1-288971733297"
      region: "us-east-1"
      image_name: "$QUAY_URL/$REPO"
      image_tag: "$BRANCH.$BUILD_NUMBER"

  hub:
    # - integrationName: "Amazon ECR - ttrahan"
    #   type: ecr
    # - integrationName: "Docker Hub"
    #   type: docker
    - integrationName: "Quay - ttrahan"
      type: quay.io
    # - integrationName: "GCR-shippable-gke"
    #   type: gcr
